rules_version = '2';

/**
 * ============================================================================
 * FIRESTORE SECURITY RULES - ERP INDUSTRIAL
 * ============================================================================
 * 
 * Regras de seguranÇõa multi-tenant:
 * - UsuÇ­rio sÇü acessa dados da prÇüpria empresa (empresaId)
 * - ValidaÇõÇœo de campos obrigatÇürios
 * - ValidaÇõÇœo de tipos de dados
 * - ProteÇõÇœo contra modificaÇõÇœo de campos sensÇðveis
 * 
 * DEPLOY:
 * firebase deploy --only firestore:rules
 * 
 * ============================================================================
 */

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================================================================
    // FUNÇÎÇES AUXILIARES
    // ========================================================================
    
    /**
     * Verifica se o usuÇ­rio estÇ­ autenticado
     */
    function isAuthenticated() {
      return request.auth != null;
    }
    
    /**
     * ObtÇ¸m o documento do usuÇ­rio autenticado (compatÇðvel com users/usuarios)
     */
    function getUserDoc() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid))
        ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data
        : get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data;
    }

    /**
     * ObtÇ¸m o empresaId do usuÇ­rio autenticado
     */
    function getEmpresaId() {
      let userData = getUserDoc();
      return userData.empresaId != null
        ? userData.empresaId
        : request.auth.uid;
    }

    /**
     * ObtÇ¸m empresaId no documento
     */
    function getDocEmpresaId(docData) {
      return docData.empresaId;
    }
    
    /**
     * Verifica se o documento pertence ao tenant do usuÇ­rio
     */
    function belongsToTenant(docData) {
      return getDocEmpresaId(docData) == getEmpresaId();
    }

    /**
     * ObtÇ¸m role do usuÇ­rio autenticado
     */
    function getUserRole() {
      return getUserDoc().role;
    }

    /**
     * Verifica se usuÇ­rio Ç¸ admin
     */
    function isAdmin() {
      return isAuthenticated() && getUserRole() in ['Administrador', 'Dono', 'administrador', 'dono', 'ADMIN', 'OWNER', 'owner'];
    }

    /**
     * ObtÇ¸m permissÇæes efetivas (customizadas ou por role)
     */
    function getRolePermissions() {
      return getUserRole() != null && exists(/databases/$(database)/documents/permissoes_roles/$(getUserRole()))
        ? get(/databases/$(database)/documents/permissoes_roles/$(getUserRole())).data.permissions
        : null;
    }

    function getEffectivePermissions() {
      return getUserDoc().permissoesCustomizadas != null
        ? getUserDoc().permissoesCustomizadas
        : getRolePermissions();
    }

    function hasPermission(module, action) {
      let perms = getEffectivePermissions();
      return perms != null && perms[module] != null && perms[module][action] == true;
    }
    
    /**
     * Verifica se campos sensÇðveis nÇœo foram modificados
     */
    function noSensitiveChanges(fields) {
      return !request.resource.data.diff(resource.data).affectedKeys().hasAny(fields);
    }
    
    // ========================================================================
    // CLIENTES
    // ========================================================================
    
    match /clientes/{clienteId} {
      // Leitura: permitida se pertence ao tenant
      allow read: if isAuthenticated() && belongsToTenant(resource.data) && hasPermission('clientes', 'view');
      
      // CriaÇõÇœo: permitida se autenticado e com empresaId correto
      allow create: if isAuthenticated()
        && hasPermission('clientes', 'create')
        && getDocEmpresaId(request.resource.data) == getEmpresaId()
        && request.resource.data.keys().hasAll(['nome', 'cnpj', 'email', 'telefone', 'cidade', 'estado', 'status'])
        && request.resource.data.cnpj is string
        && request.resource.data.cnpj.size() == 14
        && request.resource.data.email is string
        && request.resource.data.email.matches('.*@.*\\..*');
      
      // AtualizaÇõÇœo: permitida se pertence ao tenant e nÇœo modifica campos sensÇðveis
      allow update: if isAuthenticated()
        && belongsToTenant(resource.data)
        && hasPermission('clientes', 'edit')
        && noSensitiveChanges(['id', 'empresaId', 'createdAt']);
      
      // ExclusÇœo: apenas admin
      allow delete: if isAuthenticated() && belongsToTenant(resource.data) && hasPermission('clientes', 'delete');
    }

    // ========================================================================
    // PRODUTOS
    // ========================================================================

    match /produtos/{produtoId} {
      allow read: if isAuthenticated() && belongsToTenant(resource.data) && hasPermission('produtos', 'view');

      allow create: if isAuthenticated()
        && hasPermission('produtos', 'create')
        && getDocEmpresaId(request.resource.data) == getEmpresaId();

      allow update: if isAuthenticated()
        && belongsToTenant(resource.data)
        && hasPermission('produtos', 'edit')
        && noSensitiveChanges(['id', 'empresaId', 'createdAt']);

      allow delete: if isAuthenticated() && belongsToTenant(resource.data) && hasPermission('produtos', 'delete');
    }
    
    // ========================================================================
    // ORÇÎAMENTOS
    // ========================================================================
    
    match /orcamentos/{orcamentoId} {
      // Leitura: permitida se pertence ao tenant
      allow read: if isAuthenticated() && belongsToTenant(resource.data) && hasPermission('orcamentos', 'view');
      
      // CriaÇõÇœo: permitida se autenticado e com empresaId correto
      allow create: if isAuthenticated()
        && hasPermission('orcamentos', 'create')
        && getDocEmpresaId(request.resource.data) == getEmpresaId()
        && request.resource.data.keys().hasAll(['clienteId', 'clienteNome', 'status', 'itens'])
        && request.resource.data.itens.size() <= 200
        && request.resource.data.status in ['Rascunho', 'Enviado'];
      
      // AtualizaÇõÇœo: permitida se pertence ao tenant
      allow update: if isAuthenticated()
        && belongsToTenant(resource.data)
        && hasPermission('orcamentos', 'edit')
        && noSensitiveChanges(['id', 'empresaId', 'createdAt'])
        && request.resource.data.itens.size() <= 200;
      
      // ExclusÇœo: apenas rascunhos podem ser deletados
      allow delete: if isAuthenticated()
        && belongsToTenant(resource.data)
        && hasPermission('orcamentos', 'delete')
        && resource.data.status == 'Rascunho';
    }
    
    // ========================================================================
    // ORDENS DE PRODUÇÎÇŸO
    // ========================================================================
    
    match /ordens_producao/{ordemId} {
      // Leitura: permitida se pertence ao tenant
      allow read: if isAuthenticated() && belongsToTenant(resource.data) && hasPermission('ordens', 'view');
      
      // CriaÇõÇœo: permitida se autenticado e com empresaId correto
      allow create: if isAuthenticated()
        && hasPermission('ordens', 'create')
        && getDocEmpresaId(request.resource.data) == getEmpresaId()
        && request.resource.data.keys().hasAll(['clienteId', 'clienteNome', 'status', 'itens'])
        && request.resource.data.status in ['Pendente'];
      
      // AtualizaÇõÇœo: permitida se pertence ao tenant
      allow update: if isAuthenticated()
        && belongsToTenant(resource.data)
        && hasPermission('ordens', 'edit')
        && noSensitiveChanges(['id', 'empresaId', 'createdAt', 'orcamentoId']);
      
      // ExclusÇœo: apenas admin e ordens nÇœo iniciadas
      allow delete: if isAuthenticated()
        && belongsToTenant(resource.data)
        && hasPermission('ordens', 'delete')
        && resource.data.status == 'Pendente';
    }
    
    // ========================================================================
    // SOLICITAÇÎÇES DE COMPRA
    // ========================================================================
    
    match /solicitacoes_compra/{solicitacaoId} {
      // Leitura: permitida se pertence ao tenant
      allow read: if isAuthenticated() && belongsToTenant(resource.data) && hasPermission('compras', 'view');
      
      // CriaÇõÇœo: permitida se autenticado e com empresaId correto
      allow create: if isAuthenticated()
        && hasPermission('compras', 'create')
        && getDocEmpresaId(request.resource.data) == getEmpresaId()
        && request.resource.data.keys().hasAll(['status', 'itens', 'total']);
      
      // AtualizaÇõÇœo: permitida se pertence ao tenant
      allow update: if isAuthenticated()
        && belongsToTenant(resource.data)
        && hasPermission('compras', 'edit')
        && noSensitiveChanges(['id', 'empresaId', 'createdAt']);
      
      // ExclusÇœo: apenas admin
      allow delete: if isAuthenticated() && belongsToTenant(resource.data) && hasPermission('compras', 'delete');
    }

    // ========================================================================
    // COMPRAS (NOVO)
    // ========================================================================

    match /compras/{compraId} {
      allow read: if isAuthenticated() && belongsToTenant(resource.data) && hasPermission('compras', 'view');

      allow create: if isAuthenticated()
        && hasPermission('compras', 'create')
        && getDocEmpresaId(request.resource.data) == getEmpresaId();

      allow update: if isAuthenticated()
        && belongsToTenant(resource.data)
        && hasPermission('compras', 'edit')
        && noSensitiveChanges(['id', 'empresaId', 'createdAt']);

      allow delete: if isAuthenticated() && belongsToTenant(resource.data) && hasPermission('compras', 'delete');
    }
    
    // ========================================================================
    // MATERIAIS (CATÇ?LOGO)
    // ========================================================================
    
    match /materiais/{materialId} {
      // Leitura: permitida se pertence ao tenant
      allow read: if isAuthenticated() && belongsToTenant(resource.data) && hasPermission('catalogo', 'view');
      
      // CriaÇõÇœo/AtualizaÇõÇœo: apenas admin
      allow write: if isAuthenticated() && hasPermission('catalogo', 'edit') && getDocEmpresaId(request.resource.data) == getEmpresaId();
    }
    
    // ========================================================================
    // ESTOQUE DE MATERIAIS
    // ========================================================================
    
    match /estoque_materiais/{estoqueId} {
      // Leitura: permitida se pertence ao tenant
      allow read: if isAuthenticated() && belongsToTenant(resource.data) && hasPermission('estoque', 'view');
      
      // Escrita: permitida se pertence ao tenant (movimentaÇõÇæes)
      allow write: if isAuthenticated()
        && hasPermission('estoque', 'edit')
        && getDocEmpresaId(request.resource.data) == getEmpresaId();
    }

    // ========================================================================
    // ESTOQUE (NOVO)
    // ========================================================================

    match /estoque_itens/{estoqueId} {
      allow read: if isAuthenticated() && belongsToTenant(resource.data) && hasPermission('estoque', 'view');

      allow create: if isAuthenticated()
        && hasPermission('estoque', 'create')
        && getDocEmpresaId(request.resource.data) == getEmpresaId();

      allow update: if isAuthenticated()
        && belongsToTenant(resource.data)
        && hasPermission('estoque', 'edit')
        && noSensitiveChanges(['id', 'empresaId', 'createdAt']);

      allow delete: if isAuthenticated() && belongsToTenant(resource.data) && hasPermission('estoque', 'delete');
    }

    match /estoque_movimentos/{movimentoId} {
      allow read: if isAuthenticated() && belongsToTenant(resource.data) && hasPermission('estoque', 'view');

      allow create: if isAuthenticated()
        && hasPermission('estoque', 'create')
        && getDocEmpresaId(request.resource.data) == getEmpresaId();

      allow update, delete: if false;
    }
    
    // ========================================================================
    // MOVIMENTAÇÎÇES DE ESTOQUE
    // ========================================================================
    
    match /movimentacoes_estoque/{movimentacaoId} {
      // Leitura: permitida se pertence ao tenant
      allow read: if isAuthenticated() && belongsToTenant(resource.data) && hasPermission('estoque', 'view');
      
      // CriaÇõÇœo: permitida (auditoria)
      allow create: if isAuthenticated() && hasPermission('estoque', 'create') && getDocEmpresaId(request.resource.data) == getEmpresaId();
      
      // AtualizaÇõÇœo/ExclusÇœo: negada (auditoria imutÇ­vel)
      allow update, delete: if false;
    }
    
    // ========================================================================
    // APONTAMENTOS DE PRODUÇÎÇŸO
    // ========================================================================
    
    match /apontamentos/{apontamentoId} {
      // Leitura: permitida se pertence ao tenant
      allow read: if isAuthenticated() && belongsToTenant(resource.data) && hasPermission('producao', 'view');
      
      // CriaÇõÇœo: permitida
      allow create: if isAuthenticated() && hasPermission('producao', 'create') && getDocEmpresaId(request.resource.data) == getEmpresaId();
      
      // AtualizaÇõÇœo: permitida
      allow update: if isAuthenticated() && belongsToTenant(resource.data) && hasPermission('producao', 'edit');
      
      // ExclusÇœo: apenas admin
      allow delete: if isAuthenticated() && belongsToTenant(resource.data) && hasPermission('producao', 'delete');
    }
    
    // ========================================================================
    // AUDITORIA / LOGS
    // ========================================================================
    
    match /auditoria/{auditId} {
      // Leitura: apenas admin
      allow read: if isAuthenticated() && belongsToTenant(resource.data) && hasPermission('auditoria', 'view');
      
      // CriaÇõÇœo: permitida (sistema gera logs)
      allow create: if isAuthenticated() && getDocEmpresaId(request.resource.data) == getEmpresaId();
      
      // AtualizaÇõÇœo/ExclusÇœo: negada (imutÇ­vel)
      allow update, delete: if false;
    }
    
    match /logs/{logId} {
      // Mesmas regras da auditoria
      allow read: if isAuthenticated() && belongsToTenant(resource.data) && hasPermission('auditoria', 'view');
      allow create: if isAuthenticated() && getDocEmpresaId(request.resource.data) == getEmpresaId();
      allow update, delete: if false;
    }

    match /audit_logs/{logId} {
      // Auditoria nova
      allow read: if isAuthenticated() && belongsToTenant(resource.data) && hasPermission('auditoria', 'view');
      allow create: if isAuthenticated() && getDocEmpresaId(request.resource.data) == getEmpresaId();
      allow update, delete: if false;
    }
    
    // ========================================================================
    // EMPRESAS (TENANTS) - Apenas leitura do prÇüprio tenant
    // ========================================================================
    
    match /empresas/{empresaId} {
      // Leitura: apenas da prÇüpria empresa
      allow read: if isAuthenticated() && empresaId == getEmpresaId();
      
      // Escrita: negada (gerenciamento via admin console)
      allow write: if false;
    }
    
    // ========================================================================
    // USUÇ?RIOS - Apenas leitura do prÇüprio tenant
    // ========================================================================
    
    match /usuarios/{userId} {
      // Leitura (get): usuÇ­rio pode ler seu prÇüprio documento
      allow get: if isAuthenticated() && request.auth.uid == userId;

      // Listagem: apenas quem tem permissÇœo de usuÇ­rios
      allow list: if isAuthenticated() && hasPermission('usuarios', 'view');

      // CriaÇõÇœo: usuÇ­rio pode criar o prÇüprio cadastro (aguardando aprovaÇõÇœo)
      allow create: if isAuthenticated()
        && request.auth.uid == userId
        && getDocEmpresaId(request.resource.data) == getEmpresaId()
        && request.resource.data.role in ['Administrador', 'Dono', 'Financeiro', 'Producao', 'Engenharia', 'Orcamentista', 'Vendedor', 'administrador', 'dono', 'financeiro', 'producao', 'engenharia', 'orcamentista', 'vendedor', 'ADMIN', 'VENDEDOR']
        && request.resource.data.ativo == false;

      // Escrita (update/delete): apenas admin ou quem tem permissÇœo
      allow update: if isAuthenticated()
        && belongsToTenant(resource.data)
        && (isAdmin() || hasPermission('usuarios', 'edit'));

      allow delete: if isAuthenticated()
        && belongsToTenant(resource.data)
        && (isAdmin() || hasPermission('usuarios', 'delete'));
    }

    match /users/{userId} {
      // Regras equivalentes a /usuarios
      allow get: if isAuthenticated() && request.auth.uid == userId;
      allow list: if isAuthenticated() && hasPermission('usuarios', 'view');
      allow create: if isAuthenticated()
        && request.auth.uid == userId
        && getDocEmpresaId(request.resource.data) == getEmpresaId()
        && request.resource.data.role in ['Administrador', 'Dono', 'Financeiro', 'Producao', 'Engenharia', 'Orcamentista', 'Vendedor', 'administrador', 'dono', 'financeiro', 'producao', 'engenharia', 'orcamentista', 'vendedor', 'ADMIN', 'VENDEDOR']
        && request.resource.data.ativo == false;
      allow update: if isAuthenticated()
        && belongsToTenant(resource.data)
        && (isAdmin() || hasPermission('usuarios', 'edit'));
      allow delete: if isAuthenticated()
        && belongsToTenant(resource.data)
        && (isAdmin() || hasPermission('usuarios', 'delete'));
    }

    match /permissoes_roles/{roleId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated() && (isAdmin() || hasPermission('usuarios', 'edit'));
    }

    // ========================================================================
    // CONFIGURAÇÎÇES
    // ========================================================================

    match /configuracoes/{configId} {
      allow read: if isAuthenticated() && belongsToTenant(resource.data) && hasPermission('configuracoes', 'view');

      allow create: if isAuthenticated()
        && hasPermission('configuracoes', 'create')
        && getDocEmpresaId(request.resource.data) == getEmpresaId();

      allow update: if isAuthenticated()
        && belongsToTenant(resource.data)
        && hasPermission('configuracoes', 'edit')
        && noSensitiveChanges(['id', 'empresaId', 'createdAt']);

      allow delete: if isAuthenticated()
        && belongsToTenant(resource.data)
        && hasPermission('configuracoes', 'delete');
    }

    // ========================================================================
    // CALCULOS (EVENTOS)
    // ========================================================================

    match /calculos/{calculoId} {
      allow read: if isAuthenticated() && belongsToTenant(resource.data) && hasPermission('calculadora', 'view');

      allow create: if isAuthenticated()
        && hasPermission('calculadora', 'create')
        && getDocEmpresaId(request.resource.data) == getEmpresaId();

      allow update, delete: if false;
    }

    // ========================================================================
    // CALCULADORA (HISTÇ"RICO)
    // ========================================================================
    match /calculadora_historico/{docId} {
      allow read: if isAuthenticated()
        && hasPermission('calculadora', 'view')
        && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated()
        && hasPermission('calculadora', 'create')
        && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated()
        && hasPermission('calculadora', 'edit')
        && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated()
        && hasPermission('calculadora', 'delete')
        && resource.data.userId == request.auth.uid;
    }

    // ========================================================================
    // USUÇ?RIOS - APROVAÇÎÇES
    // ========================================================================
    match /usuarios_aprovacoes/{docId} {
      allow read: if isAuthenticated()
        && hasPermission('usuarios', 'view')
        && getDocEmpresaId(resource.data) == getEmpresaId();
      allow create: if isAuthenticated()
        && hasPermission('usuarios', 'edit')
        && getDocEmpresaId(request.resource.data) == getEmpresaId();
      allow update, delete: if false;
    }
    
    // ========================================================================
    // CHAT - CONVERSAS
    // ========================================================================

    match /conversas/{conversaId} {
      allow read: if isAuthenticated() && belongsToTenant(resource.data) && hasPermission('chat', 'view');

      allow create: if isAuthenticated()
        && hasPermission('chat', 'create')
        && getDocEmpresaId(request.resource.data) == getEmpresaId();

      allow update: if isAuthenticated()
        && belongsToTenant(resource.data)
        && hasPermission('chat', 'edit')
        && noSensitiveChanges(['id', 'empresaId', 'createdAt']);

      allow delete: if isAuthenticated()
        && belongsToTenant(resource.data)
        && hasPermission('chat', 'delete');
    }

    // ========================================================================
    // CHAT - MENSAGENS
    // ========================================================================

    match /mensagens/{mensagemId} {
      allow read: if isAuthenticated() && belongsToTenant(resource.data) && hasPermission('chat', 'view');

      allow create: if isAuthenticated()
        && hasPermission('chat', 'create')
        && getDocEmpresaId(request.resource.data) == getEmpresaId();

      allow update: if isAuthenticated()
        && belongsToTenant(resource.data)
        && hasPermission('chat', 'edit');

      allow delete: if false;
    }

    // ========================================================================
    // CHAT - USUÇ?RIOS DE CHAT
    // ========================================================================

    match /chat_usuarios/{chatUserId} {
      allow read: if isAuthenticated() && belongsToTenant(resource.data) && hasPermission('chat', 'view');

      allow create: if isAuthenticated()
        && hasPermission('chat', 'create')
        && getDocEmpresaId(request.resource.data) == getEmpresaId();

      allow update: if isAuthenticated()
        && belongsToTenant(resource.data)
        && hasPermission('chat', 'edit');

      allow delete: if false;
    }

    // ========================================================================
    // ANÇsNCIOS
    // ========================================================================

    match /anuncios/{anuncioId} {
      allow read: if isAuthenticated() && belongsToTenant(resource.data) && hasPermission('anuncios', 'view');

      allow create: if isAuthenticated()
        && hasPermission('anuncios', 'create')
        && getDocEmpresaId(request.resource.data) == getEmpresaId();

      allow update: if isAuthenticated()
        && belongsToTenant(resource.data)
        && hasPermission('anuncios', 'edit')
        && noSensitiveChanges(['id', 'empresaId', 'createdAt']);

      allow delete: if isAuthenticated()
        && belongsToTenant(resource.data)
        && hasPermission('anuncios', 'delete');
    }

    // ========================================================================
    // ANÇsNCIOS - LEITURAS
    // ========================================================================

    match /anuncios_leituras/{leituraId} {
      allow read: if isAuthenticated() && belongsToTenant(resource.data) && hasPermission('anuncios', 'view');

      allow create: if isAuthenticated()
        && getDocEmpresaId(request.resource.data) == getEmpresaId();

      allow update, delete: if false;
    }

    // ========================================================================
    // REGRA PADRÇŸO - NEGAR TUDO
    // ========================================================================
    
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

